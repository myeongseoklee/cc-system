# 머지 전략 가이드

파일 유형별 적응형 머지 전략 상세 가이드.

## 파일 유형별 전략

### 1. SKILL.md 파일

**전략: 섹션별 머지**

```
섹션 식별 기준: ## 헤더
비교 단위: 섹션 전체
```

**처리 규칙:**

| 상황 | 처리 |
|------|------|
| cc-system에만 있는 섹션 | 적절한 위치에 추가 |
| 프로젝트에만 있는 섹션 | 보존 (프로젝트 고유) |
| 양쪽 모두 있는 섹션 | 내용 비교 후 머지 |

**프로젝트 고유 섹션 식별:**

```markdown
<!-- PROJECT-SPECIFIC: 이 섹션은 프로젝트 전용입니다 -->
## 프로젝트 전용 워크플로우
...
<!-- /PROJECT-SPECIFIC -->
```

위 주석이 있는 섹션은 절대 수정하지 않음.

**Frontmatter 처리:**

```yaml
# cc-system (소스)
---
name: tdd-new-feature
description: 새로운 설명
---

# 프로젝트 (타겟)
---
name: tdd-new-feature
description: 프로젝트 맞춤 설명
custom-field: 프로젝트 전용 필드
---

# 결과
---
name: tdd-new-feature
description: 새로운 설명  # 업데이트
custom-field: 프로젝트 전용 필드  # 보존
---
```

---

### 2. Agent 파일 (.claude/agents/*.md)

**전략: 프롬프트 섹션 업데이트**

```
주요 업데이트 대상: system prompt 내용
보존 대상: 프로젝트별 도구 설정, 커스텀 지시사항
```

**처리 규칙:**

| 섹션 | 처리 |
|------|------|
| 역할 설명 | 업데이트 |
| 핵심 워크플로우 | 업데이트 |
| 도구 설정 | 보존 |
| 프로젝트별 지시사항 | 보존 |

**예시:**

```markdown
# cc-system (소스)
## 역할
v2 코드 구현 전문가

## 워크플로우
1. 테스트 확인
2. 구현
3. 검증

# 프로젝트 (타겟)
## 역할
v2 코드 구현 전문가 (레거시 호환 모드)

## 워크플로우
1. 테스트 확인
2. 구현

## 프로젝트 전용 설정
- 특수 린트 규칙 적용
- 커밋 전 리뷰 필수

# 결과
## 역할
v2 코드 구현 전문가 (레거시 호환 모드)  # 프로젝트 버전 보존

## 워크플로우
1. 테스트 확인
2. 구현
3. 검증  # 새 단계 추가

## 프로젝트 전용 설정  # 보존
- 특수 린트 규칙 적용
- 커밋 전 리뷰 필수
```

---

### 3. docs/*.md 문서

**전략: 섹션별 머지 + 예제 보존**

```
업데이트 대상: 개념 설명, 패턴 가이드
보존 대상: 프로젝트 고유 예제, 링크
```

**처리 규칙:**

| 내용 유형 | 처리 |
|----------|------|
| 개념 설명 | 업데이트 |
| 코드 예제 (일반) | 업데이트 |
| 코드 예제 (프로젝트 전용) | 보존 |
| 내부 링크 | 경로 조정 |
| 외부 링크 | 유지 |

**프로젝트 전용 예제 마킹:**

```markdown
## 예제

### 일반 예제
```typescript
// 이 예제는 업데이트됨
```

### 프로젝트 예제
<!-- PROJECT-EXAMPLE -->
```typescript
// 이 예제는 프로젝트 전용으로 보존됨
```
<!-- /PROJECT-EXAMPLE -->
```

---

### 4. settings.json / settings.local.json

**전략: 키별 머지**

```
업데이트: 새로운 키 추가
보존: 기존 값, 프로젝트 전용 키
```

**처리 규칙:**

```json
// cc-system (소스)
{
  "key1": "new-value",
  "key3": "new-key"
}

// 프로젝트 (타겟)
{
  "key1": "project-value",
  "key2": "project-only"
}

// 결과
{
  "key1": "project-value",  // 프로젝트 값 보존
  "key2": "project-only",   // 프로젝트 전용 키 보존
  "key3": "new-key"         // 새 키 추가
}
```

---

### 5. References 파일

**전략: 전체 교체 또는 섹션 머지**

```
가이드 문서 (how-to): 전체 교체
참조 문서 (reference): 섹션별 머지
```

**판단 기준:**

| 파일 특성 | 전략 |
|----------|------|
| 프로젝트 커스터마이징 없음 | 전체 교체 |
| 프로젝트별 추가 섹션 있음 | 섹션별 머지 |
| `<!-- NO-MERGE -->` 주석 | 머지 제외 |

---

## 섹션별 머지 알고리즘

### 1. 섹션 파싱

```
입력: 마크다운 문서
출력: 섹션 배열 [{level, title, content, start, end}]

파싱 규칙:
- # 레벨 1 헤더
- ## 레벨 2 헤더
- ### 레벨 3 헤더
- 헤더 없는 시작 부분 = "preamble" 섹션
```

### 2. 섹션 매칭

```
매칭 기준:
1. 정확히 동일한 제목
2. 유사한 제목 (정규화 후 비교)
3. 순서 기반 (같은 레벨, 같은 위치)
```

### 3. 머지 실행

```
각 섹션에 대해:
  if 소스에만 존재:
    적절한 위치에 삽입
  elif 타겟에만 존재:
    보존 (프로젝트 고유)
  else:
    내용 비교 후 머지
```

---

## 머지 vs 교체 판단 기준

| 조건 | 결정 |
|------|------|
| 파일이 cc-system에서 새로 생성됨 | 복사 (경로 조정 후) |
| 타겟에 커스터마이징 없음 | 전체 교체 |
| 타겟에 프로젝트 전용 섹션 있음 | 섹션별 머지 |
| 파일에 `<!-- NO-MERGE -->` 있음 | 머지 제외 |
| 바이너리 파일 | 복사 (확인 후) |

---

## 주의사항

### 절대 덮어쓰면 안 되는 항목

1. `<!-- PROJECT-SPECIFIC -->` 블록
2. 프로젝트 전용 frontmatter 필드
3. `.local` 접미사 파일
4. `<!-- NO-MERGE -->` 마킹된 파일

### 항상 업데이트해야 하는 항목

1. 보안 관련 가이드
2. 필수 워크플로우 단계
3. 버그 수정된 스크립트
